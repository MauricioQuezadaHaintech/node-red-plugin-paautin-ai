<!-- Editor-side: Sidebar chat plugin for Paautin AI (fully client-side) -->

<script type="text/javascript">
(function () {
    "use strict";

    // ── Constants ────────────────────────────────────────────────
    var STORAGE_KEY = "paautin-ai-settings";
    var DEFAULT_SETTINGS = {
        mode: "simple",
        apiKey: "",
        model: "claude-sonnet-4-20250514",
        companionUrl: "http://localhost:3100",
    };

    var SYSTEM_PROMPT =
        "You are a Node-RED expert assistant integrated into the Node-RED editor.\n" +
        "You help users create, modify, debug, and understand Node-RED flows.\n\n" +
        "IMPORTANT: You have tools to directly manipulate the Node-RED canvas.\n" +
        "When the user asks you to create, add, modify, move, or delete nodes, USE THE TOOLS.\n" +
        "Do not just describe what to do — actually do it with the tools.\n\n" +
        "Node-RED conventions:\n" +
        "- Node IDs: 16 lowercase hex chars (e.g. 'a1b2c3d4e5f67890'), must be unique\n" +
        "- The 'z' property must match the active tab ID (provided in context)\n" +
        "- Wires: array of arrays. wires[0] = output 0 connections, each is a target node ID\n" +
        "- Canvas layout: left-to-right, x/y in multiples of 20. Start x ~200, y ~100\n" +
        "- Horizontal spacing: ~200px between nodes. Vertical: ~60px between parallel branches\n" +
        "- Every flow should have error handling (catch + debug nodes)\n" +
        "- Debug nodes: complete msg object (complete:'true', targetType:'full')\n" +
        "- Function nodes: wrap in try/catch, use node.error(err, msg) on failure\n" +
        "- Always give nodes descriptive names\n\n" +
        "Common node types: inject, debug, function, change, switch, http in, http response,\n" +
        "template, delay, link in, link out, link call, catch, status, comment, subflow\n\n" +
        "Always respond in the same language the user writes in.";

    // ── Canvas Tools for Anthropic API ──────────────────────────
    var CANVAS_TOOLS = [
        {
            name: "import_nodes",
            description: "Import new Node-RED nodes to the active canvas tab. The nodes will appear visually in the editor. The user must click Deploy to activate. Always set z to the active tab ID from context. Generate unique 16-char hex IDs for each node.",
            input_schema: {
                type: "object",
                properties: {
                    nodes: {
                        type: "array",
                        description: "Array of Node-RED node objects. Required properties: id (16 hex), type, name, x, y, z (active tab id), wires (array of arrays). Optional: func (function nodes), rules (switch nodes), etc.",
                        items: { type: "object" }
                    }
                },
                required: ["nodes"]
            }
        },
        {
            name: "update_node",
            description: "Update properties of an existing node on the canvas. Only specified properties are changed. Can update: name, func, rules, wires, x, y, or any other node property.",
            input_schema: {
                type: "object",
                properties: {
                    node_id: { type: "string", description: "ID of the existing node to update" },
                    properties: { type: "object", description: "Key-value pairs of properties to set (e.g. {name:'New Name', func:'return msg;'})" }
                },
                required: ["node_id", "properties"]
            }
        },
        {
            name: "delete_nodes",
            description: "Delete nodes from the canvas by their IDs. Removes nodes and their connections.",
            input_schema: {
                type: "object",
                properties: {
                    node_ids: { type: "array", items: { type: "string" }, description: "Array of node IDs to remove from the canvas" }
                },
                required: ["node_ids"]
            }
        }
    ];

    // ── State ────────────────────────────────────────────────────
    var settings = loadSettings();
    var conversation = [];
    var streaming = false;
    var abortController = null;

    // ── DOM refs ─────────────────────────────────────────────────
    var $messages, $textarea, $sendBtn, $stopBtn, $modeSelect,
        $contextToggle, $clearBtn, $statusDot, $settingsPanel, $settingsBtn;
    var includeContext = true;

    // ── Settings persistence (localStorage) ──────────────────────
    function loadSettings() {
        try {
            var s = JSON.parse(localStorage.getItem(STORAGE_KEY));
            return Object.assign({}, DEFAULT_SETTINGS, s || {});
        } catch (_e) {
            return Object.assign({}, DEFAULT_SETTINGS);
        }
    }

    function saveSettings() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    }

    // ── Markdown renderer (minimal) ──────────────────────────────
    function escapeHtml(text) {
        var div = document.createElement("div");
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    function renderMarkdown(text) {
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function (_, lang, code) {
            return '<pre class="pai-code-block"><code>' + escapeHtml(code.trim()) + "</code></pre>";
        });
        text = text.replace(/`([^`\n]+)`/g, '<code class="pai-inline-code">$1</code>');
        text = text.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, "<em>$1</em>");
        text = text.replace(/\n/g, "<br>");
        return text;
    }

    // ── Gather flow context from editor ──────────────────────────
    function gatherFlowContext() {
        var tabId = RED.workspaces.active();
        if (!tabId) return null;

        var nodes = [];
        RED.nodes.eachNode(function (n) {
            if (n.z === tabId) {
                var obj = { id: n.id, type: n.type, name: n.name || "", x: Math.round(n.x), y: Math.round(n.y), wires: n.wires };
                // Include key properties per node type (compact)
                if (n.url) obj.url = n.url;
                if (n.method) obj.method = n.method;
                if (n.topic) obj.topic = n.topic;
                if (n.func) obj.func = n.func.length > 200 ? n.func.substring(0, 200) + "..." : n.func;
                nodes.push(obj);
            }
        });

        var tab = RED.nodes.workspace(tabId);
        return { tabId: tabId, tabLabel: tab ? tab.label : tabId, nodeCount: nodes.length, nodes: nodes };
    }

    // ── Canvas Actions ───────────────────────────────────────────
    function executeCanvasAction(toolName, input) {
        var tabId = RED.workspaces.active();
        var result = { success: false, message: "" };

        try {
            if (toolName === "import_nodes") {
                var nodes = input.nodes || [];
                // Ensure z is set to active tab
                nodes.forEach(function (n) {
                    if (!n.z) n.z = tabId;
                });
                RED.nodes.import(JSON.stringify(nodes));
                RED.nodes.dirty(true);
                RED.view.redraw(true);
                var names = nodes.map(function (n) { return n.name || n.type; }).join(", ");
                result.success = true;
                result.message = "Imported " + nodes.length + " nodes: " + names;

            } else if (toolName === "update_node") {
                var node = RED.nodes.node(input.node_id);
                if (!node) {
                    result.message = "Node " + input.node_id + " not found on canvas.";
                } else {
                    var props = input.properties || {};
                    Object.keys(props).forEach(function (key) {
                        node[key] = props[key];
                    });
                    node.changed = true;
                    node.dirty = true;
                    RED.nodes.dirty(true);
                    RED.view.redraw(true);
                    result.success = true;
                    result.message = "Updated node " + (node.name || node.id) + " (" + Object.keys(props).join(", ") + ")";
                }

            } else if (toolName === "delete_nodes") {
                var ids = input.node_ids || [];
                var deleted = 0;
                ids.forEach(function (id) {
                    var n = RED.nodes.node(id);
                    if (n) {
                        RED.nodes.remove(id);
                        deleted++;
                    }
                });
                RED.nodes.dirty(true);
                RED.view.redraw(true);
                result.success = true;
                result.message = "Deleted " + deleted + " of " + ids.length + " nodes.";
            } else {
                result.message = "Unknown tool: " + toolName;
            }
        } catch (err) {
            result.message = "Canvas error: " + err.message;
        }

        return result;
    }

    // ── Version & Logo ──────────────────────────────────────────
    var PLUGIN_VERSION = "0.2.0";
    var HAINTECH_LOGO_SVG = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="pai-logo">' +
        '<rect width="32" height="32" rx="6" fill="#1a73e8"/>' +
        '<text x="16" y="22" text-anchor="middle" font-family="Arial,sans-serif" font-weight="bold" font-size="16" fill="#fff">E</text>' +
        '</svg>';

    // ── UI Construction ──────────────────────────────────────────
    function buildUI() {
        var $content = $("<div>", { class: "pai-container" });

        // ─ Header with logo ─
        var $header = $("<div>", { class: "pai-header" });
        $header.html(
            HAINTECH_LOGO_SVG +
            '<span class="pai-header-title">Eheken v' + PLUGIN_VERSION + '</span>' +
            '<span class="pai-header-by">by HainTech</span>'
        );

        // ─ Toolbar ─
        var $toolbar = $("<div>", { class: "pai-toolbar" });

        $statusDot = $("<span>", { class: "pai-status-dot pai-status-idle" });

        $modeSelect = $("<select>", { class: "pai-mode-select" })
            .append('<option value="simple">API Directa</option>')
            .append('<option value="claude-code">Claude Code</option>');
        $modeSelect.val(settings.mode);

        $contextToggle = $("<button>", {
            class: "pai-toolbar-btn pai-context-active",
            title: "Incluir flow activo como contexto",
        }).html('<i class="fa fa-sitemap"></i>');

        $settingsBtn = $("<button>", {
            class: "pai-toolbar-btn",
            title: "Configuracion",
        }).html('<i class="fa fa-cog"></i>');

        $clearBtn = $("<button>", {
            class: "pai-toolbar-btn",
            title: "Limpiar conversacion",
        }).html('<i class="fa fa-trash"></i>');

        $toolbar.append($statusDot).append($modeSelect).append($contextToggle).append($settingsBtn).append($clearBtn);

        // ─ Settings panel (hidden by default) ─
        $settingsPanel = $("<div>", { class: "pai-settings", style: "display:none" });
        $settingsPanel.html(
            '<div class="pai-settings-row">' +
            '  <label>API Key <small>(modo API Directa)</small></label>' +
            '  <input type="password" id="pai-set-apikey" placeholder="sk-ant-..." value="' + escapeHtml(settings.apiKey) + '">' +
            '</div>' +
            '<div class="pai-settings-row">' +
            '  <label>Modelo <small>(modo API Directa)</small></label>' +
            '  <select id="pai-set-model">' +
            '    <option value="claude-opus-4-20250514"' + (settings.model === "claude-opus-4-20250514" ? " selected" : "") + '>Opus 4</option>' +
            '    <option value="claude-sonnet-4-20250514"' + (settings.model === "claude-sonnet-4-20250514" ? " selected" : "") + '>Sonnet 4</option>' +
            '    <option value="claude-haiku-4-20250506"' + (settings.model === "claude-haiku-4-20250506" ? " selected" : "") + '>Haiku 4</option>' +
            '  </select>' +
            '</div>' +
            '<div class="pai-settings-row">' +
            '  <label>Companion URL <small>(modo Claude Code)</small></label>' +
            '  <input type="text" id="pai-set-companion" value="' + escapeHtml(settings.companionUrl) + '">' +
            '</div>' +
            '<div class="pai-settings-row" style="text-align:right">' +
            '  <button id="pai-set-save" class="pai-settings-save">Guardar</button>' +
            '</div>'
        );

        // ─ Messages area ─
        $messages = $("<div>", { class: "pai-messages" });
        addMessageToUI("assistant",
            "Hola! Soy el asistente AI de **HainTech** para Node-RED.\n" +
            "Puedo crear, modificar y eliminar nodos directamente en el canvas.\n" +
            "Selecciona un modo arriba y escribe tu pregunta."
        );

        // ─ Input area ─
        var $inputArea = $("<div>", { class: "pai-input-area" });
        $textarea = $("<textarea>", { class: "pai-textarea", placeholder: "Escribe tu mensaje...", rows: 1 });
        $sendBtn = $("<button>", { class: "pai-send-btn" }).html('<i class="fa fa-paper-plane"></i>');
        $stopBtn = $("<button>", { class: "pai-stop-btn", style: "display:none" }).html('<i class="fa fa-stop"></i>');
        $inputArea.append($textarea).append($sendBtn).append($stopBtn);

        // Assemble
        $content.append($header).append($toolbar).append($settingsPanel).append($messages).append($inputArea);

        // ─ Events ─
        $sendBtn.on("click", sendMessage);
        $stopBtn.on("click", function () { if (abortController) abortController.abort(); });
        $textarea.on("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        $textarea.on("input", function () {
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });
        $modeSelect.on("change", function () { settings.mode = $(this).val(); saveSettings(); });
        $contextToggle.on("click", function () {
            includeContext = !includeContext;
            $(this).toggleClass("pai-context-active", includeContext);
        });
        $settingsBtn.on("click", function () { $settingsPanel.toggle(); });
        $clearBtn.on("click", function () {
            conversation = [];
            $messages.empty();
            addMessageToUI("assistant", "Conversacion limpiada.");
        });

        // Settings save
        $settingsPanel.on("click", "#pai-set-save", function () {
            settings.apiKey = $("#pai-set-apikey").val().trim();
            settings.model = $("#pai-set-model").val();
            settings.companionUrl = $("#pai-set-companion").val().trim();
            saveSettings();
            $settingsPanel.hide();
            updateStatusDot();
        });

        updateStatusDot();
        return { content: $content };
    }

    // ── Status indicator ─────────────────────────────────────────
    function updateStatusDot() {
        $statusDot.removeClass("pai-status-error");
        if (settings.mode === "simple" && !settings.apiKey) {
            $statusDot.addClass("pai-status-error").attr("title", "API Key no configurada");
        } else if (settings.mode === "claude-code") {
            fetch(settings.companionUrl + "/health", { signal: AbortSignal.timeout(2000) })
                .then(function (r) { return r.json(); })
                .then(function () { $statusDot.attr("title", "Companion conectado"); })
                .catch(function () {
                    $statusDot.addClass("pai-status-error").attr("title", "Companion no disponible en " + settings.companionUrl);
                });
        }
    }

    // ── Messages ─────────────────────────────────────────────────
    function addMessageToUI(role, text) {
        var $msg = $("<div>", { class: "pai-msg pai-msg-" + role });
        var $bubble = $("<div>", { class: "pai-bubble pai-bubble-" + role });
        $bubble.html(renderMarkdown(text));
        $msg.append($bubble);
        $messages.append($msg);
        scrollToBottom();
        return $bubble;
    }

    function addToolUseToUI(tool, input) {
        var $msg = $("<div>", { class: "pai-msg pai-msg-tool" });
        var label = typeof input === "object" ? JSON.stringify(input).substring(0, 80) : String(input);
        var $bubble = $("<div>", { class: "pai-bubble pai-bubble-tool" });
        $bubble.html('<i class="fa fa-wrench"></i> <strong>' + escapeHtml(tool) + "</strong> " +
            '<span class="pai-tool-detail">' + escapeHtml(label) + "</span>");
        $msg.append($bubble);
        $messages.append($msg);
        scrollToBottom();
    }

    function addActionToUI(toolName, result) {
        var $msg = $("<div>", { class: "pai-msg pai-msg-action" });
        var icon = result.success ? "fa-check-circle" : "fa-times-circle";
        var cls = result.success ? "pai-action-ok" : "pai-action-fail";
        var $bubble = $("<div>", { class: "pai-bubble pai-bubble-action " + cls });
        $bubble.html('<i class="fa ' + icon + '"></i> ' + escapeHtml(result.message));
        $msg.append($bubble);
        $messages.append($msg);
        scrollToBottom();
    }

    function scrollToBottom() {
        $messages[0].scrollTop = $messages[0].scrollHeight;
    }

    // ── Send message (routes to correct mode) ────────────────────
    function sendMessage() {
        var text = $textarea.val().trim();
        if (!text || streaming) return;

        addMessageToUI("user", text);
        conversation.push({ role: "user", content: text });
        $textarea.val("").css("height", "auto");

        var flowContext = includeContext ? gatherFlowContext() : null;

        streaming = true;
        abortController = new AbortController();
        $sendBtn.hide();
        $stopBtn.show();
        $statusDot.removeClass("pai-status-idle pai-status-error").addClass("pai-status-streaming");

        var promise;
        if (settings.mode === "simple") {
            promise = streamAnthropicDirect(flowContext);
        } else {
            var $bubble = addMessageToUI("assistant", "");
            promise = streamClaudeCode(text, flowContext, $bubble);
        }

        promise.catch(function (err) {
            if (err.name !== "AbortError") {
                addMessageToUI("assistant", "");
                $messages.find(".pai-bubble-assistant").last()
                    .html('<span class="pai-error"><i class="fa fa-exclamation-triangle"></i> ' + escapeHtml(err.message) + "</span>");
            }
        }).finally(function () {
            finishStream();
        });
    }

    // ── Mode: API Directa with Tool Use (browser → Anthropic) ───
    function streamAnthropicDirect(flowContext) {
        if (!settings.apiKey) {
            return Promise.reject(new Error("API Key no configurada. Abre el engranaje para configurarla."));
        }

        // Build system prompt with flow context
        var system = SYSTEM_PROMPT;
        var tabId = RED.workspaces.active();
        if (tabId) {
            var tab = RED.nodes.workspace(tabId);
            system += "\n\nActive tab ID: " + tabId + " (label: " + (tab ? tab.label : "unknown") + ")";
            system += "\nUse this as the 'z' value when creating nodes.";
        }
        if (flowContext && flowContext.nodes.length > 0) {
            system += "\n\nCurrent nodes on this tab (" + flowContext.nodeCount + " nodes):\n```json\n" +
                JSON.stringify(flowContext.nodes) + "\n```";
        }

        // Build messages from conversation
        var messages = conversation.map(function (m) {
            return { role: m.role, content: m.content };
        });

        // Recursive function to handle multi-turn tool use
        function doRequest(msgs) {
            return fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": settings.apiKey,
                    "anthropic-version": "2023-06-01",
                    "anthropic-dangerous-direct-browser-access": "true",
                },
                body: JSON.stringify({
                    model: settings.model,
                    max_tokens: 8192,
                    system: system,
                    messages: msgs,
                    tools: CANVAS_TOOLS,
                    stream: true,
                }),
                signal: abortController.signal,
            }).then(function (response) {
                if (!response.ok) {
                    return response.text().then(function (t) {
                        if (response.status === 429) {
                            throw new Error("Rate limit alcanzado. Intenta con un modelo mas liviano (Sonnet/Haiku) o espera un minuto.");
                        }
                        if (response.status === 401) {
                            throw new Error("API Key invalida. Revisa la configuracion.");
                        }
                        throw new Error("Anthropic API " + response.status + ": " + t);
                    });
                }

                // Create a bubble for this response
                var $bubble = addMessageToUI("assistant", "");
                return parseAnthropicToolStream(response, $bubble);

            }).then(function (result) {
                // result = { content: [...], stop_reason, fullText }

                // Add assistant message to messages for multi-turn
                msgs.push({ role: "assistant", content: result.content });

                // Execute any tool uses and collect results
                var toolResults = [];
                result.content.forEach(function (block) {
                    if (block.type === "tool_use") {
                        var actionResult = executeCanvasAction(block.name, block.input);
                        addActionToUI(block.name, actionResult);
                        toolResults.push({
                            type: "tool_result",
                            tool_use_id: block.id,
                            content: JSON.stringify(actionResult)
                        });
                    }
                });

                // If Claude used tools, send results back and continue
                if (result.stop_reason === "tool_use" && toolResults.length > 0) {
                    msgs.push({ role: "user", content: toolResults });
                    return doRequest(msgs);
                }

                // Conversation is done — save the final text
                if (result.fullText) {
                    conversation.push({ role: "assistant", content: result.fullText });
                }
            });
        }

        return doRequest(messages);
    }

    // ── Parse Anthropic stream with tool use support ─────────────
    function parseAnthropicToolStream(response, $bubble) {
        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var buffer = "";

        // Track content blocks
        var contentBlocks = [];
        var fullText = "";
        var stopReason = null;

        function processLine(line) {
            if (!line.startsWith("data: ")) return;
            var data = line.slice(6).trim();
            if (!data || data === "[DONE]") return;

            try {
                var evt = JSON.parse(data);

                if (evt.type === "content_block_start") {
                    var block = {
                        type: evt.content_block.type,
                        text: evt.content_block.text || "",
                        id: evt.content_block.id || null,
                        name: evt.content_block.name || null,
                        inputJson: ""
                    };
                    contentBlocks[evt.index] = block;

                    // Show tool indicator immediately
                    if (block.type === "tool_use") {
                        addToolUseToUI(block.name, "preparando...");
                    }

                } else if (evt.type === "content_block_delta") {
                    var b = contentBlocks[evt.index];
                    if (!b) return;

                    if (evt.delta.type === "text_delta") {
                        b.text += evt.delta.text;
                        fullText += evt.delta.text;
                        $bubble.html(renderMarkdown(fullText));
                        scrollToBottom();
                    } else if (evt.delta.type === "input_json_delta") {
                        b.inputJson += evt.delta.partial_json;
                    }

                } else if (evt.type === "message_delta") {
                    if (evt.delta && evt.delta.stop_reason) {
                        stopReason = evt.delta.stop_reason;
                    }
                }
            } catch (_e) { /* skip malformed lines */ }
        }

        function read() {
            return reader.read().then(function (result) {
                if (result.done) {
                    // Build content array for the conversation
                    var content = [];
                    contentBlocks.forEach(function (b) {
                        if (!b) return;
                        if (b.type === "text" && b.text) {
                            content.push({ type: "text", text: b.text });
                        } else if (b.type === "tool_use") {
                            var input = {};
                            try { input = JSON.parse(b.inputJson); } catch (_e) {}
                            content.push({ type: "tool_use", id: b.id, name: b.name, input: input });
                        }
                    });

                    return { content: content, stop_reason: stopReason, fullText: fullText };
                }

                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split("\n");
                buffer = lines.pop();
                lines.forEach(processLine);

                return read();
            });
        }

        return read();
    }

    // ── Mode: Claude Code (browser → localhost companion) ────────
    function streamClaudeCode(text, flowContext, $bubble) {
        return fetch(settings.companionUrl + "/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: text, flowContext: flowContext }),
            signal: abortController.signal,
        }).then(function (response) {
            if (!response.ok) {
                return response.text().then(function (t) { throw new Error("Companion " + response.status + ": " + t); });
            }
            return readSSEStream(response, $bubble, function (line) {
                if (!line.startsWith("data: ")) return null;
                var data = line.slice(6).trim();
                if (!data || data === "[DONE]") return null;
                try { return JSON.parse(data); } catch (_e) { return null; }
            });
        });
    }

    // ── Generic SSE stream reader (for Claude Code mode) ─────────
    function readSSEStream(response, $bubble, parseLine) {
        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var buffer = "";
        var fullText = "";

        function read() {
            return reader.read().then(function (result) {
                if (result.done) return fullText;

                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split("\n");
                buffer = lines.pop();

                lines.forEach(function (line) {
                    var evt = parseLine(line);
                    if (!evt) return;

                    if (evt.type === "text") {
                        fullText += evt.content;
                        $bubble.html(renderMarkdown(fullText));
                        scrollToBottom();
                    } else if (evt.type === "result" && typeof evt.content === "string") {
                        fullText = evt.content;
                        $bubble.html(renderMarkdown(fullText));
                        scrollToBottom();
                    } else if (evt.type === "tool_use") {
                        var c = evt.content || evt;
                        addToolUseToUI(c.tool, c.input);
                    } else if (evt.type === "error") {
                        $bubble.html('<span class="pai-error"><i class="fa fa-exclamation-triangle"></i> ' + escapeHtml(evt.content) + "</span>");
                    }
                });

                return read();
            });
        }

        return read().then(function (text) {
            if (text) conversation.push({ role: "assistant", content: text });
        });
    }

    function finishStream() {
        streaming = false;
        abortController = null;
        $sendBtn.show();
        $stopBtn.hide();
        $statusDot.removeClass("pai-status-streaming").addClass("pai-status-idle");
        $textarea.focus();
    }

    // ── Register Plugin ──────────────────────────────────────────
    RED.plugins.registerPlugin("paautin-ai-sidebar", {
        type: "paautin-ai",
        onadd: function () {
            var ui = buildUI();

            RED.sidebar.addTab({
                id: "paautin-ai",
                label: "Haintech AI",
                name: "Haintech AI - Eheken Assistant",
                iconClass: "fa fa-comments",
                content: ui.content[0],
                enableOnEdit: true,
                action: "core:show-paautin-ai-tab",
            });

            RED.actions.add("core:show-paautin-ai-tab", function () {
                RED.sidebar.show("paautin-ai");
            });
        },
    });
})();
</script>

<!-- ── Styles ──────────────────────────────────────────────────── -->
<style>
.pai-container {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    display: flex; flex-direction: column; overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 13px; background: #f7f7f7;
}
.pai-header {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 10px; background: #fff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;
}
.pai-logo { width: 28px; height: 28px; }
.pai-header-title { font-size: 14px; font-weight: 700; color: #333; }
.pai-header-by { font-size: 10px; color: #999; margin-left: auto; }
.pai-toolbar {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 8px; background: #eee; border-bottom: 1px solid #ddd; flex-shrink: 0;
}
.pai-mode-select {
    flex: 1; font-size: 11px; padding: 3px 4px;
    border: 1px solid #ccc; border-radius: 3px; background: #fff;
}
.pai-toolbar-btn {
    background: none; border: 1px solid transparent; cursor: pointer;
    padding: 3px 6px; border-radius: 3px; color: #666; font-size: 12px;
}
.pai-toolbar-btn:hover { background: #ddd; border-color: #ccc; }
.pai-context-active { color: #2196f3 !important; border-color: #2196f3 !important; background: #e3f2fd !important; }
.pai-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
.pai-status-idle { background: #4caf50; }
.pai-status-streaming { background: #ff9800; animation: pai-pulse 1s infinite; }
.pai-status-error { background: #f44336; }
@keyframes pai-pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

/* Settings panel */
.pai-settings {
    padding: 10px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0;
}
.pai-settings-row { margin-bottom: 8px; }
.pai-settings-row label { display: block; font-size: 11px; font-weight: 600; color: #555; margin-bottom: 3px; }
.pai-settings-row small { font-weight: normal; color: #999; }
.pai-settings-row input, .pai-settings-row select {
    width: 100%; padding: 5px 8px; font-size: 12px; border: 1px solid #ccc;
    border-radius: 4px; box-sizing: border-box;
}
.pai-settings-save {
    background: #2196f3; color: #fff; border: none; padding: 5px 16px;
    border-radius: 4px; cursor: pointer; font-size: 12px;
}
.pai-settings-save:hover { background: #1976d2; }

/* Messages */
.pai-messages { flex: 1; min-height: 0; overflow-y: auto; padding: 10px 8px; display: flex; flex-direction: column; gap: 8px; }
.pai-msg { display: flex; max-width: 100%; }
.pai-msg-user { justify-content: flex-end; }
.pai-msg-assistant, .pai-msg-tool, .pai-msg-action { justify-content: flex-start; }
.pai-bubble { padding: 8px 12px; border-radius: 12px; max-width: 92%; line-height: 1.45; word-break: break-word; }
.pai-bubble-user { background: #2196f3; color: #fff; border-bottom-right-radius: 4px; }
.pai-bubble-assistant { background: #fff; color: #333; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
.pai-bubble-tool { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; border-radius: 8px; font-size: 11px; padding: 5px 10px; }
.pai-tool-detail { margin-left: 6px; color: #999; font-size: 10px; }

/* Canvas action results */
.pai-bubble-action { border-radius: 8px; font-size: 11px; padding: 5px 10px; }
.pai-action-ok { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
.pai-action-ok .fa { color: #4caf50; }
.pai-action-fail { background: #fce4ec; color: #c62828; border: 1px solid #f8bbd0; }
.pai-action-fail .fa { color: #f44336; }

.pai-code-block {
    background: #1e1e1e; color: #d4d4d4; padding: 8px 10px; border-radius: 6px;
    overflow-x: auto; font-family: "Menlo","Monaco","Courier New",monospace;
    font-size: 11px; line-height: 1.4; margin: 6px 0; white-space: pre;
}
.pai-inline-code { background: #f0f0f0; color: #c7254e; padding: 1px 4px; border-radius: 3px; font-family: "Menlo","Monaco","Courier New",monospace; font-size: 11px; }
.pai-bubble-user .pai-inline-code { background: rgba(255,255,255,0.2); color: #fff; }
.pai-error { color: #d32f2f; }
.pai-stopped { color: #999; font-size: 11px; }

/* Input */
.pai-input-area { display: flex; align-items: flex-end; gap: 6px; padding: 8px; border-top: 1px solid #ddd; background: #fff; flex-shrink: 0; }
.pai-textarea {
    flex: 1; resize: none; border: 1px solid #ccc; border-radius: 8px; padding: 8px 10px;
    font-size: 13px; font-family: inherit; line-height: 1.4; max-height: 120px; outline: none;
}
.pai-textarea:focus { border-color: #2196f3; box-shadow: 0 0 0 2px rgba(33,150,243,0.15); }
.pai-send-btn, .pai-stop-btn {
    width: 34px; height: 34px; border: none; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px;
}
.pai-send-btn { background: #2196f3; color: #fff; }
.pai-send-btn:hover { background: #1976d2; }
.pai-stop-btn { background: #f44336; color: #fff; }
.pai-stop-btn:hover { background: #d32f2f; }
.pai-messages::-webkit-scrollbar { width: 5px; }
.pai-messages::-webkit-scrollbar-track { background: transparent; }
.pai-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
</style>
