<!-- Editor-side: Sidebar chat plugin for Paautin AI (fully client-side) -->

<script type="text/javascript">
(function () {
    "use strict";

    // ── Constants ────────────────────────────────────────────────
    var STORAGE_KEY = "paautin-ai-settings";
    var DEFAULT_SETTINGS = {
        mode: "claude-code",
        apiKey: "",
        model: "claude-sonnet-4-20250514",
        companionUrl: "http://localhost:3100",
    };

    var SYSTEM_PROMPT =
        "You are a Node-RED expert assistant.\n" +
        "You help users create, modify, debug, and understand Node-RED flows.\n\n" +
        "Key conventions:\n" +
        "- Node IDs: 16 hex chars, lowercase, unique across project\n" +
        "- Every flow needs a Catch group for error handling\n" +
        "- Nodes must have descriptive names\n" +
        "- Canvas layout: left-to-right, grid-aligned (multiples of 20px)\n" +
        "- Debug nodes: complete=true, targetType=full\n" +
        "- Function nodes: use try/catch, node.error(msg, originalMsg), never throw\n\n" +
        "When suggesting flow changes, provide valid JSON.\n" +
        "Always respond in the same language the user writes in.";

    // ── State ────────────────────────────────────────────────────
    var settings = loadSettings();
    var conversation = [];
    var streaming = false;
    var abortController = null;

    // ── DOM refs ─────────────────────────────────────────────────
    var $messages, $textarea, $sendBtn, $stopBtn, $modeSelect,
        $contextToggle, $clearBtn, $statusDot, $settingsPanel, $settingsBtn;
    var includeContext = true;

    // ── Settings persistence (localStorage) ──────────────────────
    function loadSettings() {
        try {
            var s = JSON.parse(localStorage.getItem(STORAGE_KEY));
            return Object.assign({}, DEFAULT_SETTINGS, s || {});
        } catch (_e) {
            return Object.assign({}, DEFAULT_SETTINGS);
        }
    }

    function saveSettings() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    }

    // ── Markdown renderer (minimal) ──────────────────────────────
    function escapeHtml(text) {
        var div = document.createElement("div");
        div.appendChild(document.createTextNode(text));
        return div.innerHTML;
    }

    function renderMarkdown(text) {
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function (_, lang, code) {
            return '<pre class="pai-code-block"><code>' + escapeHtml(code.trim()) + "</code></pre>";
        });
        text = text.replace(/`([^`\n]+)`/g, '<code class="pai-inline-code">$1</code>');
        text = text.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        text = text.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, "<em>$1</em>");
        text = text.replace(/\n/g, "<br>");
        return text;
    }

    // ── Gather flow context from editor ──────────────────────────
    function gatherFlowContext() {
        var tabId = RED.workspaces.active();
        if (!tabId) return null;

        var nodes = [];
        RED.nodes.eachNode(function (n) {
            if (n.z === tabId) {
                var obj = { id: n.id, type: n.type, name: n.name || "", x: n.x, y: n.y, wires: n.wires };
                if (n.func) obj.func = n.func;
                if (n.rules) obj.rules = n.rules;
                nodes.push(obj);
            }
        });

        var tab = RED.nodes.workspace(tabId);
        return { tabId: tabId, tabLabel: tab ? tab.label : tabId, nodeCount: nodes.length, nodes: nodes };
    }

    // ── Logo (base64 embedded) ─────────────────────────────────
    var HAINTECH_LOGO = "data:image/png;base64,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";

    // ── UI Construction ──────────────────────────────────────────
    function buildUI() {
        var $content = $("<div>", { class: "pai-container" });

        // ─ Header with logo ─
        var $header = $("<div>", { class: "pai-header" });
        $header.html(
            '<img src="' + HAINTECH_LOGO + '" class="pai-logo" alt="HainTech">' +
            '<span class="pai-header-title">Paautin AI</span>' +
            '<span class="pai-header-by">by HainTech</span>'
        );

        // ─ Toolbar ─
        var $toolbar = $("<div>", { class: "pai-toolbar" });

        $statusDot = $("<span>", { class: "pai-status-dot pai-status-idle" });

        $modeSelect = $("<select>", { class: "pai-mode-select" })
            .append('<option value="simple">API Directa</option>')
            .append('<option value="claude-code">Claude Code</option>');
        $modeSelect.val(settings.mode);

        $contextToggle = $("<button>", {
            class: "pai-toolbar-btn pai-context-active",
            title: "Incluir flow activo como contexto",
        }).html('<i class="fa fa-sitemap"></i>');

        $settingsBtn = $("<button>", {
            class: "pai-toolbar-btn",
            title: "Configuracion",
        }).html('<i class="fa fa-cog"></i>');

        $clearBtn = $("<button>", {
            class: "pai-toolbar-btn",
            title: "Limpiar conversacion",
        }).html('<i class="fa fa-trash"></i>');

        $toolbar.append($statusDot).append($modeSelect).append($contextToggle).append($settingsBtn).append($clearBtn);

        // ─ Settings panel (hidden by default) ─
        $settingsPanel = $("<div>", { class: "pai-settings", style: "display:none" });
        $settingsPanel.html(
            '<div class="pai-settings-row">' +
            '  <label>API Key <small>(modo API Directa)</small></label>' +
            '  <input type="password" id="pai-set-apikey" placeholder="sk-ant-..." value="' + escapeHtml(settings.apiKey) + '">' +
            '</div>' +
            '<div class="pai-settings-row">' +
            '  <label>Modelo <small>(modo API Directa)</small></label>' +
            '  <select id="pai-set-model">' +
            '    <option value="claude-opus-4-20250514"' + (settings.model === "claude-opus-4-20250514" ? " selected" : "") + '>Opus 4</option>' +
            '    <option value="claude-sonnet-4-20250514"' + (settings.model === "claude-sonnet-4-20250514" ? " selected" : "") + '>Sonnet 4</option>' +
            '    <option value="claude-haiku-4-20250506"' + (settings.model === "claude-haiku-4-20250506" ? " selected" : "") + '>Haiku 4</option>' +
            '  </select>' +
            '</div>' +
            '<div class="pai-settings-row">' +
            '  <label>Companion URL <small>(modo Claude Code)</small></label>' +
            '  <input type="text" id="pai-set-companion" value="' + escapeHtml(settings.companionUrl) + '">' +
            '</div>' +
            '<div class="pai-settings-row" style="text-align:right">' +
            '  <button id="pai-set-save" class="pai-settings-save">Guardar</button>' +
            '</div>'
        );

        // ─ Messages area ─
        $messages = $("<div>", { class: "pai-messages" });
        addMessageToUI("assistant",
            "Hola! Soy el asistente AI de **HainTech** para Node-RED.\n" +
            "Selecciona un modo arriba y escribe tu pregunta."
        );

        // ─ Input area ─
        var $inputArea = $("<div>", { class: "pai-input-area" });
        $textarea = $("<textarea>", { class: "pai-textarea", placeholder: "Escribe tu mensaje...", rows: 1 });
        $sendBtn = $("<button>", { class: "pai-send-btn" }).html('<i class="fa fa-paper-plane"></i>');
        $stopBtn = $("<button>", { class: "pai-stop-btn", style: "display:none" }).html('<i class="fa fa-stop"></i>');
        $inputArea.append($textarea).append($sendBtn).append($stopBtn);

        // Assemble
        $content.append($header).append($toolbar).append($settingsPanel).append($messages).append($inputArea);

        // ─ Events ─
        $sendBtn.on("click", sendMessage);
        $stopBtn.on("click", function () { if (abortController) abortController.abort(); });
        $textarea.on("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        $textarea.on("input", function () {
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });
        $modeSelect.on("change", function () { settings.mode = $(this).val(); saveSettings(); });
        $contextToggle.on("click", function () {
            includeContext = !includeContext;
            $(this).toggleClass("pai-context-active", includeContext);
        });
        $settingsBtn.on("click", function () { $settingsPanel.toggle(); });
        $clearBtn.on("click", function () {
            conversation = [];
            $messages.empty();
            addMessageToUI("assistant", "Conversacion limpiada.");
        });

        // Settings save
        $settingsPanel.on("click", "#pai-set-save", function () {
            settings.apiKey = $("#pai-set-apikey").val().trim();
            settings.model = $("#pai-set-model").val();
            settings.companionUrl = $("#pai-set-companion").val().trim();
            saveSettings();
            $settingsPanel.hide();
            updateStatusDot();
        });

        updateStatusDot();
        return { content: $content, toolbar: $toolbar };
    }

    // ── Status indicator ─────────────────────────────────────────
    function updateStatusDot() {
        $statusDot.removeClass("pai-status-error");
        if (settings.mode === "simple" && !settings.apiKey) {
            $statusDot.addClass("pai-status-error").attr("title", "API Key no configurada");
        } else if (settings.mode === "claude-code") {
            // Check companion health
            fetch(settings.companionUrl + "/health", { signal: AbortSignal.timeout(2000) })
                .then(function (r) { return r.json(); })
                .then(function () { $statusDot.attr("title", "Companion conectado"); })
                .catch(function () {
                    $statusDot.addClass("pai-status-error").attr("title", "Companion no disponible en " + settings.companionUrl);
                });
        }
    }

    // ── Messages ─────────────────────────────────────────────────
    function addMessageToUI(role, text) {
        var $msg = $("<div>", { class: "pai-msg pai-msg-" + role });
        var $bubble = $("<div>", { class: "pai-bubble pai-bubble-" + role });
        $bubble.html(renderMarkdown(text));
        $msg.append($bubble);
        $messages.append($msg);
        scrollToBottom();
        return $bubble;
    }

    function addToolUseToUI(tool, input) {
        var $msg = $("<div>", { class: "pai-msg pai-msg-tool" });
        var label = typeof input === "object" ? JSON.stringify(input).substring(0, 80) : String(input);
        var $bubble = $("<div>", { class: "pai-bubble pai-bubble-tool" });
        $bubble.html('<i class="fa fa-wrench"></i> <strong>' + escapeHtml(tool) + "</strong> " +
            '<span class="pai-tool-detail">' + escapeHtml(label) + "</span>");
        $msg.append($bubble);
        $messages.append($msg);
        scrollToBottom();
    }

    function scrollToBottom() {
        $messages[0].scrollTop = $messages[0].scrollHeight;
    }

    // ── Send message (routes to correct mode) ────────────────────
    function sendMessage() {
        var text = $textarea.val().trim();
        if (!text || streaming) return;

        addMessageToUI("user", text);
        conversation.push({ role: "user", content: text });
        $textarea.val("").css("height", "auto");

        var flowContext = includeContext ? gatherFlowContext() : null;

        streaming = true;
        $sendBtn.hide();
        $stopBtn.show();
        $statusDot.removeClass("pai-status-idle pai-status-error").addClass("pai-status-streaming");

        var $bubble = addMessageToUI("assistant", "");
        abortController = new AbortController();

        var promise;
        if (settings.mode === "simple") {
            promise = streamAnthropicDirect(text, flowContext, $bubble);
        } else {
            promise = streamClaudeCode(text, flowContext, $bubble);
        }

        promise.catch(function (err) {
            if (err.name === "AbortError") {
                $bubble.html($bubble.html() + '<br><em class="pai-stopped">[Detenido]</em>');
            } else {
                $bubble.html('<span class="pai-error"><i class="fa fa-exclamation-triangle"></i> ' + escapeHtml(err.message) + "</span>");
            }
        }).finally(function () {
            finishStream($bubble);
        });
    }

    // ── Mode: API Directa (browser → Anthropic) ─────────────────
    function streamAnthropicDirect(text, flowContext, $bubble) {
        if (!settings.apiKey) {
            return Promise.reject(new Error("API Key no configurada. Abre el engranaje para configurarla."));
        }

        var messages = conversation.map(function (m) { return { role: m.role, content: m.content }; });
        var system = SYSTEM_PROMPT;
        if (flowContext && flowContext.nodes.length > 0) {
            system += "\n\nActive flow (tab: " + flowContext.tabLabel + "):\n```json\n" +
                JSON.stringify(flowContext.nodes, null, 2) + "\n```";
        }

        return fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "x-api-key": settings.apiKey,
                "anthropic-version": "2023-06-01",
                "anthropic-dangerous-direct-browser-access": "true",
            },
            body: JSON.stringify({
                model: settings.model,
                max_tokens: 8192,
                system: system,
                messages: messages,
                stream: true,
            }),
            signal: abortController.signal,
        }).then(function (response) {
            if (!response.ok) {
                return response.text().then(function (t) { throw new Error("Anthropic API " + response.status + ": " + t); });
            }
            return readSSEStream(response, $bubble, function (line) {
                // Parse Anthropic SSE events
                if (!line.startsWith("data: ")) return null;
                var data = line.slice(6).trim();
                if (!data || data === "[DONE]") return null;
                try {
                    var evt = JSON.parse(data);
                    if (evt.type === "content_block_delta" && evt.delta && evt.delta.type === "text_delta") {
                        return { type: "text", content: evt.delta.text };
                    }
                } catch (_e) {}
                return null;
            });
        });
    }

    // ── Mode: Claude Code (browser → localhost companion) ────────
    function streamClaudeCode(text, flowContext, $bubble) {
        return fetch(settings.companionUrl + "/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: text, flowContext: flowContext }),
            signal: abortController.signal,
        }).then(function (response) {
            if (!response.ok) {
                return response.text().then(function (t) { throw new Error("Companion " + response.status + ": " + t); });
            }
            return readSSEStream(response, $bubble, function (line) {
                if (!line.startsWith("data: ")) return null;
                var data = line.slice(6).trim();
                if (!data || data === "[DONE]") return null;
                try { return JSON.parse(data); } catch (_e) { return null; }
            });
        });
    }

    // ── Generic SSE stream reader ────────────────────────────────
    function readSSEStream(response, $bubble, parseLine) {
        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var buffer = "";
        var fullText = "";

        function read() {
            return reader.read().then(function (result) {
                if (result.done) return fullText;

                buffer += decoder.decode(result.value, { stream: true });
                var lines = buffer.split("\n");
                buffer = lines.pop();

                lines.forEach(function (line) {
                    var evt = parseLine(line);
                    if (!evt) return;

                    if (evt.type === "text") {
                        fullText += evt.content;
                        $bubble.html(renderMarkdown(fullText));
                        scrollToBottom();
                    } else if (evt.type === "result" && typeof evt.content === "string") {
                        fullText = evt.content;
                        $bubble.html(renderMarkdown(fullText));
                        scrollToBottom();
                    } else if (evt.type === "tool_use") {
                        var c = evt.content || evt;
                        addToolUseToUI(c.tool, c.input);
                    } else if (evt.type === "error") {
                        $bubble.html('<span class="pai-error"><i class="fa fa-exclamation-triangle"></i> ' + escapeHtml(evt.content) + "</span>");
                    }
                });

                return read();
            });
        }

        return read().then(function (text) {
            if (text) conversation.push({ role: "assistant", content: text });
        });
    }

    function finishStream() {
        streaming = false;
        abortController = null;
        $sendBtn.show();
        $stopBtn.hide();
        $statusDot.removeClass("pai-status-streaming").addClass("pai-status-idle");
        $textarea.focus();
    }

    // ── Register Plugin ──────────────────────────────────────────
    RED.plugins.registerPlugin("paautin-ai-sidebar", {
        type: "paautin-ai",
        onadd: function () {
            var ui = buildUI();

            RED.sidebar.addTab({
                id: "paautin-ai",
                label: "hAIntech",
                name: "hAIntech - Paautin AI Assistant",
                iconClass: "fa fa-comments",
                content: ui.content[0],
                toolbar: ui.toolbar[0],
                enableOnEdit: true,
                action: "core:show-paautin-ai-tab",
            });

            RED.actions.add("core:show-paautin-ai-tab", function () {
                RED.sidebar.show("paautin-ai");
            });
        },
    });
})();
</script>

<!-- ── Styles ──────────────────────────────────────────────────── -->
<style>
.pai-container {
    display: flex; flex-direction: column; height: 100%; max-height: 100%; overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 13px; background: #f7f7f7;
}
.pai-header {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 10px; background: #fff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;
}
.pai-logo { width: 28px; height: 28px; }
.pai-header-title { font-size: 14px; font-weight: 700; color: #333; }
.pai-header-by { font-size: 10px; color: #999; margin-left: auto; }
.pai-toolbar {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 8px; background: #eee; border-bottom: 1px solid #ddd; flex-shrink: 0;
}
.pai-mode-select {
    flex: 1; font-size: 11px; padding: 3px 4px;
    border: 1px solid #ccc; border-radius: 3px; background: #fff;
}
.pai-toolbar-btn {
    background: none; border: 1px solid transparent; cursor: pointer;
    padding: 3px 6px; border-radius: 3px; color: #666; font-size: 12px;
}
.pai-toolbar-btn:hover { background: #ddd; border-color: #ccc; }
.pai-context-active { color: #2196f3 !important; border-color: #2196f3 !important; background: #e3f2fd !important; }
.pai-status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
.pai-status-idle { background: #4caf50; }
.pai-status-streaming { background: #ff9800; animation: pai-pulse 1s infinite; }
.pai-status-error { background: #f44336; }
@keyframes pai-pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

/* Settings panel */
.pai-settings {
    padding: 10px; background: #fff; border-bottom: 1px solid #ddd; flex-shrink: 0;
}
.pai-settings-row { margin-bottom: 8px; }
.pai-settings-row label { display: block; font-size: 11px; font-weight: 600; color: #555; margin-bottom: 3px; }
.pai-settings-row small { font-weight: normal; color: #999; }
.pai-settings-row input, .pai-settings-row select {
    width: 100%; padding: 5px 8px; font-size: 12px; border: 1px solid #ccc;
    border-radius: 4px; box-sizing: border-box;
}
.pai-settings-save {
    background: #2196f3; color: #fff; border: none; padding: 5px 16px;
    border-radius: 4px; cursor: pointer; font-size: 12px;
}
.pai-settings-save:hover { background: #1976d2; }

/* Messages */
.pai-messages { flex: 1; min-height: 0; overflow-y: auto; padding: 10px 8px; display: flex; flex-direction: column; gap: 8px; }
.pai-msg { display: flex; max-width: 100%; }
.pai-msg-user { justify-content: flex-end; }
.pai-msg-assistant, .pai-msg-tool { justify-content: flex-start; }
.pai-bubble { padding: 8px 12px; border-radius: 12px; max-width: 92%; line-height: 1.45; word-break: break-word; }
.pai-bubble-user { background: #2196f3; color: #fff; border-bottom-right-radius: 4px; }
.pai-bubble-assistant { background: #fff; color: #333; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
.pai-bubble-tool { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; border-radius: 8px; font-size: 11px; padding: 5px 10px; }
.pai-tool-detail { margin-left: 6px; color: #999; font-size: 10px; }
.pai-code-block {
    background: #1e1e1e; color: #d4d4d4; padding: 8px 10px; border-radius: 6px;
    overflow-x: auto; font-family: "Menlo","Monaco","Courier New",monospace;
    font-size: 11px; line-height: 1.4; margin: 6px 0; white-space: pre;
}
.pai-inline-code { background: #f0f0f0; color: #c7254e; padding: 1px 4px; border-radius: 3px; font-family: "Menlo","Monaco","Courier New",monospace; font-size: 11px; }
.pai-bubble-user .pai-inline-code { background: rgba(255,255,255,0.2); color: #fff; }
.pai-error { color: #d32f2f; }
.pai-stopped { color: #999; font-size: 11px; }

/* Input */
.pai-input-area { display: flex; align-items: flex-end; gap: 6px; padding: 8px; border-top: 1px solid #ddd; background: #fff; flex-shrink: 0; }
.pai-textarea {
    flex: 1; resize: none; border: 1px solid #ccc; border-radius: 8px; padding: 8px 10px;
    font-size: 13px; font-family: inherit; line-height: 1.4; max-height: 120px; outline: none;
}
.pai-textarea:focus { border-color: #2196f3; box-shadow: 0 0 0 2px rgba(33,150,243,0.15); }
.pai-send-btn, .pai-stop-btn {
    width: 34px; height: 34px; border: none; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px;
}
.pai-send-btn { background: #2196f3; color: #fff; }
.pai-send-btn:hover { background: #1976d2; }
.pai-stop-btn { background: #f44336; color: #fff; }
.pai-stop-btn:hover { background: #d32f2f; }
.pai-messages::-webkit-scrollbar { width: 5px; }
.pai-messages::-webkit-scrollbar-track { background: transparent; }
.pai-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
</style>
